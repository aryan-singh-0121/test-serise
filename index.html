<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CHE-110 â€” Test Series (Units 1-6)</title>
<style>
/* ===================== CSS Variables ===================== */
:root{
    --bg:#10a482; /* Background main color variable */
    --card:#0d0e0f; /* Card background color variable */
    --accent:#1d6c52; /* Main accent color */
    --accent-600:#059669; /* Darker accent */
    --accent-400:#44a631; /* Lighter accent */
    --danger:#d41212b8; /* Error/danger color */
    --muted:#1e2939; /* Muted text color */
    --glass:rgba(52, 36, 36, 0.03); /* Glassy overlay color */
}

/* ===================== Global Styles ===================== */
*{
    box-sizing:border-box; /* Padding + border included in element width/height */
    font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial; /* Default font stack */
}
html,body{
    height:100%; /* Full height for page */
}
body{
    margin:0; /* Remove default margin */
    background:
        radial-gradient(900px 500px at 10% 10%, rgba(210, 47, 142, 0.04), transparent), /* Decorative radial gradient */
        linear-gradient(180deg,#3171e0 0%, #29cacf 100%); /* Main page gradient background */
    color:#070b0f; /* Default text color */
    min-height:100vh; /* Minimum height full viewport */
    display:flex; /* Flex layout */
    align-items:center; /* Vertically center content */
    justify-content:center; /* Horizontally center content */
    padding:18px; /* Page padding */
}

/* ===================== Layout Wrappers ===================== */
.wrap{
    width:100%; /* Full width */
    max-width:1100px; /* Max width for large screens */
    margin:0 auto; /* Center horizontally */
}
.card{
    background:linear-gradient(180deg, rgba(5, 3, 3, 0.02), rgba(0,0,0,0.12)); /* Card gradient */
    border-radius:14px; /* Rounded corners */
    padding:18px; /* Inner spacing */
    box-shadow:0 10px 40px rgba(2,6,23,0.7); /* Shadow under card */
    border:1px solid rgba(255,255,255,0.03); /* Subtle border */
}

/* ===================== Header ===================== */
header{
    display:flex; /* Flex layout */
    justify-content:space-between; /* Space between title and other elements */
    align-items:flex-start; /* Align at top */
    gap:12px; /* Gap between items */
}
.title{
    display:flex; /* Flex for vertical layout */
    flex-direction:column; /* Stack title + subtitle vertically */
}
h1{
    margin:0; /* Remove default margin */
    font-size:20px; /* Title font size */
}
.small-by{
    font-size:12px; /* Small subtitle text */
    color:var(--muted); /* Muted color */
    margin-top:6px; /* Space above */
}
.accent-badge{
    background:linear-gradient(90deg,var(--accent-400),var(--accent)); /* Gradient badge */
    padding:6px 10px; /* Inner spacing */
    border-radius:8px; /* Rounded corners */
    color:#022; /* Text color inside badge */
    font-weight:700; /* Bold */
}

/* ===================== Start area ===================== */
.start-area{
    display:flex; /* Flex layout */
    gap:14px; /* Gap between inputs/buttons */
    align-items:flex-start; /* Align at top */
    margin-top:12px; /* Top spacing */
}
.inputs{
    display:flex; /* Flex layout */
    flex-direction:column; /* Stack inputs vertically */
    gap:8px; /* Space between inputs */
}
input[type="text"], input[type="file"]{
    padding:10px; /* Inner spacing */
    border-radius:8px; /* Rounded corners */
    border:1px solid rgba(255,255,255,0.05); /* Border style */
    background:transparent; /* Transparent input background */
    color:inherit; /* Same as body color */
    width:280px; /* Fixed input width */
}

/* ===================== About box ===================== */
.about{
    background:linear-gradient(180deg, rgba(184, 11, 11, 0.01), rgba(156, 43, 43, 0.02)); /* Light background gradient */
    padding:12px; /* Inner spacing */
    border-radius:10px; /* Rounded corners */
    border:1px solid rgba(105, 0, 0, 0.02); /* Light border */
    max-width:600px; /* Max width */
}
.about p{
    margin:6px 0; /* Paragraph spacing */
    color:var(--muted); /* Muted color */
    font-size:13px; /* Small text */
}

/* ===================== Buttons ===================== */
.btn{
    padding:10px 14px; /* Inner spacing */
    border-radius:10px; /* Rounded */
    border:0; /* No border */
    cursor:pointer; /* Pointer on hover */
    font-weight:700; /* Bold */
    background:var(--accent); /* Main accent color */
    color:rgb(0, 0, 0); /* Text color */
    box-shadow:0 6px 20px rgba(14, 239, 164, 0.08); /* Shadow */
    transition:transform .14s ease, box-shadow .14s ease; /* Smooth interaction */
}
.btn:active{
    transform:translateY(2px); /* Button press effect */
}
.btn.ghost{
    background:transparent; /* Ghost button */
    border:1px solid rgb(89, 33, 33); /* Light border */
    color:rgb(142, 64, 0); /* Text color */
}
.btn.warn{
    background:var(--danger); /* Red background for warning */
    color:#52aeb7; /* Text color */
}

/* ===================== Row flex ===================== */
.row{
    display:flex; /* Flex layout */
    gap:8px; /* Gap between items */
    align-items:center; /* Vertical center */
}
.muted{
    color:var(--muted); /* Muted text */
    font-size:13px; /* Small text */
}

/* ===================== Main Layout ===================== */
.main{
    display:flex; /* Flex layout */
    gap:16px; /* Gap between left and right */
    margin-top:16px; /* Top spacing */
}
.left{
    flex:1; /* Left area grows */
}
.right{
    width:320px; /* Fixed width for right panel */
}

/* ===================== Top Status boxes ===================== */
.topstatus{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap; /* Wrap to next line if overflow */
}
.status-box{
    background:var(--glass); /* Glassy background */
    padding:8px 10px; /* Inner padding */
    border-radius:8px;
    min-width:80px; /* Minimum width */
    text-align:center; /* Center text */
    font-size:13px;
}
.status-box .label{
    color:var(--muted);
    font-size:12px;
}
.status-box .val{
    font-weight:800;
    margin-top:4px;
}

/* ===================== Question Area ===================== */
.question-area{
    margin-top:12px;
    padding:18px;
    border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
    border:1px solid rgba(255,255,255,0.02);
}
.qtop{
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.qtext{
    font-size:19px;
    font-weight:700;
    margin:12px 0;
}
.options{
    display:grid; /* Grid layout */
    grid-template-columns:1fr 1fr; /* Two columns for options */
    gap:12px; /* Gap between options */
}
.option{
    padding:12px;
    border-radius:10px;
    border:1px solid rgba(91, 206, 248, 0.438);
    cursor:pointer;
    background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    transition:transform .18s cubic-bezier(.2,.9,.3,1), box-shadow .18s ease, background .18s ease;
}
.option:hover{
    transform:translateY(-4px); /* Hover lift effect */
    box-shadow:0 10px 30px rgba(24, 54, 185, 0.6);
}
.option .label{
    font-weight:750;
}
.option .explainTiny{
    font-size:12px;
    color:var(--muted);
    padding:10px 10px;
    border-radius:10px;
    border:5px solid rgba(255,255,255,0.02);
}

/* ===================== Option states ===================== */
.option.correct{
    background:linear-gradient(90deg, rgba(11, 29, 23, 0.12), rgba(22, 69, 53, 0.06));
    border-color:rgba(16,185,129,0.28);
    color:var(--accent);
    box-shadow:0 10px 30px rgba(16,185,129,0.06), 0 0 18px rgba(16,185,129,0.06) inset;
    animation:glow 900ms ease forwards; /* Green glow animation */
}
.option.wrong{
    background:linear-gradient(90deg, rgba(239,68,68,0.06), rgba(239,68,68,0.03));
    border-color:rgba(5, 5, 5, 0.22);
    color:var(--danger);
    animation:shake .45s linear; /* Red shake animation */
}

/* ===================== Animations ===================== */
@keyframes glow{
    0%{box-shadow:0 0 0 rgba(16,185,129,0)}
    50%{box-shadow:0 0 20px rgba(113, 234, 194, 0.08)}
    100%{box-shadow:0 0 6px rgba(16,185,129,0.04)}
}
@keyframes shake{
    0%{transform:translateX(0)}
    25%{transform:translateX(-6px)}
    50%{transform:translateX(6px)}
    75%{transform:translateX(-4px)}
    100%{transform:translateX(0)}
}

/* ===================== Explanation box ===================== */
.explain{
    font-size:14px;
    color:var(--muted);
    margin-top:10px;
    padding:12px;
    border-radius:10px;
    background:rgba(0,0,0,0.05);
    display:none; /* Hidden by default */
}

/* ===================== Controls and Footer ===================== */
.controls{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-top:14px;
}
.nav{
    display:flex;
    gap:8px;
    align-items:center;
}
.footer{
    margin-top:12px;
    color:var(--muted);
    font-size:13px;
}

/* ===================== Modal ===================== */
.modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(2,6,23,0.6); /* Semi-transparent backdrop */
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:60;
}
.modal{
    background:#d3d8e3;
    padding:16px;
    border-radius:12px;
    width:90%;
    max-width:720px;
    border:1px solid rgba(255,255,255,0.03);
}
.modal h3{
    margin:0 0 8px;
}
.results-table{
    width:100%;
    border-collapse:collapse;
    margin-top:8px;
}
.results-table th,.results-table td{
    padding:8px;
    border-bottom:1px solid rgba(255,255,255,0.03);
    text-align:left;
    font-size:13px;
}
.img-preview{
    width:56px;
    height:56px;
    border-radius:8px;
    object-fit:cover;
    border:1px solid rgba(255,255,255,0.04);
}

/* ===================== Responsive ===================== */
@media(max-width:880px){
    .main{flex-direction:column;} /* Stack left & right vertically */
    .right{width:100%;} /* Right panel full width */
    .options{grid-template-columns:1fr;} /* Single column for options */
}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="cardRoot">
      <header>
        <div class="title">
          <div style="display:flex;align-items:center;gap:10px">
            <h1>CHE-110 â€” Test Series (Units 1-6)</h1>
            <div class="accent-badge" id="badgeCount">300+ Qs</div>
          </div>
          <div class="small-by">Created by <strong>Aryan Singh</strong></div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
          <div style="font-size:12px;color:var(--muted)">BY:- <strong style="color:var(--accent)">ARYAN SINGH ðŸ¥·</strong></div>
        </div>
      </header>

      <!-- START PAGE -->
      <div id="startPage" style="margin-top:12px">
        <div class="start-area">
          <div class="inputs">
            <input id="inpName" type="text" placeholder="Enter full name "  />
            <input id="inpReg" type="text" placeholder="Registration number" />
            <div style="display:flex;align-items:center;gap:8px">
              <input id="inpPic" type="file" accept="image/*" />
              <img id="imgPreview" class="img-preview" src="" alt="profile picture" style="display:none" />
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="btnStart" class="btn" disabled>Start Test</button>
              <button id="btnResetStart" class="btn ghost">Reset</button>
            </div>
            <div id="startErrors" style="color:#ffcccb;font-size:13px;margin-top:6px"></div>
          </div>
          <div class="about">
            <strong>About this Test</strong>
            <p>â€¢ 300+ MCQs covering Units 1-6. One question at a time.</p>
            <p>â€¢ Name & Registration number are mandatory. Profile picture optional.</p>
            <p>â€¢ No hard time limit, but inactivity of 60s shows a warning.</p>
            <p>â€¢ Wrong answers do not increase progress percentage (progress = correct / total).</p>
          </div>
        </div>
      </div>

      <!-- TEST PAGE (hidden initially) -->
      <div id="testPage" style="display:none">
        <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap" class="topstatus">
            <div class="status-box"><div class="label">Time</div><div class="val" id="timeTop">00:00</div></div>
            <div class="status-box"><div class="label">Correct</div><div class="val" id="topCorrect">0</div></div>
            <div class="status-box"><div class="label">Wrong</div><div class="val" id="topWrong">0</div></div>
            <div class="status-box"><div class="label">Progress</div><div class="val" id="topProgress">0%</div></div>
            <div class="status-box"><div class="label">Attempted</div><div class="val" id="topAttempted">0</div></div>
            <div class="status-box"><div class="label">Q</div><div class="val" id="topQno">0/300</div></div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="muted" id="showUser">â€”</div>
            <button id="btnEndTestTop" class="btn warn">End Test</button>
          </div>
        </div>

        <div class="main">
          <div class="left">
            <div class="question-area">
              <div class="qtop">
                <div class="muted">Name: <span id="showName">â€”</span> â€¢ Reg: <span id="showReg">â€”</span></div>
                <div class="muted">Progress: <span id="progressPercent">0%</span></div>
              </div>
              <div class="qtext" id="questionText">Loading...</div>
              <div class="options" id="optionsBox"></div>
              <div class="explain" id="explainBox"></div>

              <div class="controls">
                <div class="nav">
                  <button id="btnPrev" class="btn ghost">Prev</button>
                  <button id="btnNext" class="btn ghost">Next</button>
                  <button id="btnShowExplain" class="btn ghost">Show Explanation</button>
                </div>
                <div class="muted">Score: <span id="scoreInline">0</span></div>
              </div>
            </div>
            <div class="footer">Tip: Click the correct option â€” it turns <span style="color:var(--accent);font-weight:700">green</span>. Wrong picks become <span style="color:var(--danger);font-weight:700">red</span>.</div>
          </div>

          <aside class="right">
            <div class="scorebox">
              <div class="row" style="justify-content:space-between;align-items:center">
                <div style="display:flex;gap:8px;align-items:center">
                  <div style="display:flex;flex-direction:column"><div class="muted" style="font-size:12px">Questions</div><div style="font-weight:800" id="curQ">0</div></div>
                  <div style="display:flex;flex-direction:column"><div class="muted" style="font-size:12px">Total</div><div style="font-weight:800" id="totalQ">300</div></div>
                </div>
                <img id="userPicSmall" class="img-preview" src="" style="display:none">
              </div>

              <div style="display:flex;gap:8px;margin-top:8px">
                <div style="flex:1"><div class="label muted">Correct</div><div id="correctCount" style="font-weight:800">0</div></div>
                <div style="flex:1"><div class="label muted">Wrong</div><div id="wrongCount" style="font-weight:800">0</div></div>
              </div>

              <div style="display:flex;gap:8px;margin-top:10px">
                <div style="flex:1"><div class="label muted">Attempted</div><div id="attemptedCount" style="font-weight:800">0</div></div>
                <div style="flex:1"><div class="label muted">Time</div><div id="timeSpent" style="font-weight:800">00:00</div></div>
              </div>
               <div style="border: 2px solid #555; background-color: transparent; padding: 10px; width: fit-content; border-radius: 5px; font-family: sans-serif; font-size: 14px; color: inherit; margin: 15px 0;">
                    <strong>How to View Answers:</strong>
                    <ol style="margin: 5px 0 0 20px; padding: 0;">
                        <li>Click <b>"End Test"</b></li>
                        <li>Click <b>"OK"</b></li>
                       <li>Click <b>"OK"</b> again</li>
                        <li>Click <b>"Review Answers"</b></li>
                    </ol>
                </div>

              <div style="margin-top:10px;display:flex;gap:8px">
                <!-- <button id="btnSave" class="btn">Save Result</button> -->
                <button id="btnExport" class="btn ghost">Export CSV</button>
              </div>
            </div>
          </aside>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

  const SUPABASE_URL = "https://kqfdyvqrhytbjyszsxmr.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxZmR5dnFyaHl0Ymp5c3pzeG1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NDkzNzQsImV4cCI6MjA4MDIyNTM3NH0.-WpfPxH7Q3xE5UF5448ERdsdSjYTiefF4nVymSM9cu0";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  window.supabase = supabase;
</script>
<script>const QUESTIONS = [


];
// end QUESTIONS array

/* 300 QUESTIONS: We created 300 items above. */
/* If you paste the full 300 questions, make sure to update totalQ below automatically. */

const totalQ = QUESTIONS.length || 300;
document.getElementById('totalQ').innerText = totalQ;
document.getElementById('badgeCount').innerText = totalQ + " Qs";

/* ============== App State ============== */
let state = {
  current: 0,
  answers: Array(totalQ).fill(null), // user's selected index
  answeredCorrect: Array(totalQ).fill(false),
  started: false,
  startTime: null,
  elapsedSec: 0,
  timerInterval: null,
  idleTimer: null
};

/* ============== DOM refs ============== */
const startPage = document.getElementById('startPage');
const testPage = document.getElementById('testPage');
const inpName = document.getElementById('inpName');
const inpReg = document.getElementById('inpReg');
const inpPic = document.getElementById('inpPic');
const imgPreview = document.getElementById('imgPreview');
const btnStart = document.getElementById('btnStart');
const btnResetStart = document.getElementById('btnResetStart');
const startErrors = document.getElementById('startErrors');

const showName = document.getElementById('showName');
const showReg = document.getElementById('showReg');
const userPicSmall = document.getElementById('userPicSmall');
const showUser = document.getElementById('showUser');

const timeTop = document.getElementById('timeTop');
const topCorrect = document.getElementById('topCorrect');
const topWrong = document.getElementById('topWrong');
const topProgress = document.getElementById('topProgress');
const topAttempted = document.getElementById('topAttempted');
const topQno = document.getElementById('topQno');

const questionText = document.getElementById('questionText');
const optionsBox = document.getElementById('optionsBox');
const explainBox = document.getElementById('explainBox');
const btnPrev = document.getElementById('btnPrev');
const btnNext = document.getElementById('btnNext');
const btnShowExplain = document.getElementById('btnShowExplain');
const btnEndTestTop = document.getElementById('btnEndTestTop');

const curQ = document.getElementById('curQ');
const correctCountEl = document.getElementById('correctCount');
const wrongCountEl = document.getElementById('wrongCount');
const attemptedCountEl = document.getElementById('attemptedCount');
const timeSpentEl = document.getElementById('timeSpent');
const scoreInline = document.getElementById('scoreInline');
const progressPercent = document.getElementById('progressPercent');

const btnSave = document.getElementById('btnSave');
const btnExport = document.getElementById('btnExport');

const modalRoot = document.getElementById('modalRoot');

/* ============== Helpers ============== */
function formatTime(sec){
  const m = Math.floor(sec/60).toString().padStart(2,'0');
  const s = (sec%60).toString().padStart(2,'0');
  return `${m}:${s}`;
}
function updateTopStatus(){
  const attempted = state.answers.filter(a=>a!==null).length;
  const correct = state.answeredCorrect.filter(x=>x).length;
  const wrong = attempted - correct;
  topCorrect.innerText = correct;
  topWrong.innerText = wrong;
  topAttempted.innerText = attempted;
  topProgress.innerText = `${Math.round((correct/totalQ)*100)}%`;
  topQno.innerText = `${state.current+1}/${totalQ}`;
  // right side small summary
  correctCountEl.innerText = correct;
  wrongCountEl.innerText = wrong;
  attemptedCountEl.innerText = attempted;
  scoreInline.innerText = correct;
  curQ.innerText = state.current + 1;
  progressPercent.innerText = `${Math.round((correct/totalQ)*100)}%`;
}
function startTimer(){
  if(state.timerInterval) return;
  state.startTime = Date.now() - (state.elapsedSec*1000);
  state.timerInterval = setInterval(()=>{
    state.elapsedSec = Math.floor((Date.now()-state.startTime)/1000);
    timeTop.innerText = formatTime(state.elapsedSec);
    timeSpentEl.innerText = formatTime(state.elapsedSec);
  },1000);
}
function stopTimer(){
  if(state.timerInterval){ clearInterval(state.timerInterval); state.timerInterval = null; }
}
function resetIdleTimer(){
  if(state.idleTimer) clearTimeout(state.idleTimer);
  // show warning if no action for 60s
  state.idleTimer = setTimeout(()=>{ showWarning("You're idle â€” please continue answering to use time well."); }, 60000);
}
function showWarning(text){
  // small non-blocking toast modal that disappears
  const toast = document.createElement('div');
  toast.style.position='fixed'; toast.style.left='50%'; toast.style.transform='translateX(-50%)'; toast.style.bottom='22px';
  toast.style.background='rgba(0,0,1,0.8)'; toast.style.padding='12px 16px'; toast.style.borderRadius='10px'; toast.style.color='#fef'; toast.style.zIndex=9999;
  toast.innerText = "âš ï¸ " + text;
  document.body.appendChild(toast);
  setTimeout(()=>{ toast.style.transition='opacity .4s'; toast.style.opacity='0'; setTimeout(()=>toast.remove(),400); }, 3000);
}

/* ============== Validation (start page) ============== */
function validateName(v){
  if(!v || !v.trim()) return false;
  // allow letters, spaces, dot and hyphen optional; disallow digits
  return /^[A-Za-z\s\.\-']+$/.test(v.trim());
}
function validateReg(v){
  return /^\d{8}$/.test(v);
}
function checkStartInputs(){
  const name = inpName.value.trim();
  const reg = inpReg.value.trim();
  let ok = true; startErrors.innerText = '';
  if(!validateName(name)){ ok = false; startErrors.innerText = 'Name invalid: only letters, spaces allowed.'; }
  else if(!validateReg(reg)){ ok = false; startErrors.innerText = 'Registration invalid: must be exactly 8 digits.'; }
  btnStart.disabled = !ok;
}

/* image preview */
inpPic.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f){ imgPreview.style.display='none'; userPicSmall.style.display='none'; return; }
  const url = URL.createObjectURL(f);
  imgPreview.src = url; imgPreview.style.display='block';
  userPicSmall.src = url; userPicSmall.style.display='block';
});

/* listen to inputs */
inpName.addEventListener('input', checkStartInputs);
inpReg.addEventListener('input', checkStartInputs);

/* ============== Rendering ============== */
function renderQuestion(idx){
  resetIdleTimer();
  const item = QUESTIONS[idx];
  if(!item){
    questionText.innerText = 'Question bank not loaded. Paste the QUESTIONS array into the file.';
    optionsBox.innerHTML = '';
    return;
  }
  questionText.innerHTML = `<span style="opacity:.9">${idx+1}.</span> <span style="margin-left:8px">${item.q}</span>`;
  showName.innerText = inpName.value || 'â€”';
  showReg.innerText = inpReg.value || 'â€”';
  showUser.innerText = `${inpName.value || ''} â€¢ ${inpReg.value || ''}`;
  explainBox.style.display = 'none'; explainBox.innerHTML = '';
  optionsBox.innerHTML = '';

  item.options.forEach((optText, i)=>{
    const div = document.createElement('div');
    div.className = 'option';
    div.dataset.index = i;
    div.innerHTML = `<div class="label"><strong>${String.fromCharCode(65+i)}</strong>. ${optText}</div><div class="explainTiny">Explain</div>`;
    // answer click
    div.addEventListener('click', (e)=>{
      if(state.answers[idx] !== null) return; // locked
      handleAnswer(idx, i);
    });
    // explain click
    div.querySelector('.explainTiny').addEventListener('click', (ev)=>{ ev.stopPropagation(); showExplanation(idx); });
    optionsBox.appendChild(div);
  });

  // if answered already, show colors
  if(state.answers[idx] !== null){
    const chosen = state.answers[idx];
    const correct = QUESTIONS[idx].answer;
    const all = optionsBox.querySelectorAll('.option');
    all.forEach((od, i)=>{
      od.classList.remove('correct','wrong');
      if(i === correct) od.classList.add('correct');
      if(i === chosen && chosen !== correct) od.classList.add('wrong');
    });
    explainBox.innerHTML = `<strong>Explanation:</strong><br>${item.explanation}<br><br><strong>Correct:</strong> ${String.fromCharCode(65+item.answer)}. ${item.options[item.answer]}`;
    explainBox.style.display = 'none';
  }

  updateTopStatus();
}

/* ============== Answer Logic ============== */
function handleAnswer(qIdx, choiceIdx){
  // lock once selected
  if(state.answers[qIdx] !== null) return;
  state.answers[qIdx] = choiceIdx;
  const correct = QUESTIONS[qIdx].answer;
  const wasCorrect = (choiceIdx === correct);
  state.answeredCorrect[qIdx] = wasCorrect;

  // color options
  const optDivs = optionsBox.querySelectorAll('.option');
  optDivs.forEach((od, i)=>{
    od.classList.remove('correct','wrong');
    if(i === correct) od.classList.add('correct');
    if(i === choiceIdx && choiceIdx !== correct) od.classList.add('wrong');
  });

  updateTopStatus();

  // brief animation & then auto-next after 700ms
  if(wasCorrect){
    const correctEl = optionsBox.querySelector('.option.correct');
    if(correctEl) correctEl.animate([{transform:'scale(1)'},{transform:'scale(1.03)'},{transform:'scale(1)'}], {duration:450, iterations:1, easing:'ease-out'});
  }

  // small delay then go next (unless last)
  setTimeout(()=>{
    if(state.current < totalQ - 1){
      state.current++;
      renderQuestion(state.current);
    } else {
      // reached end - show modal summary
      showSummaryModal();
    }
  }, 2000);
}

/* explanation */
function showExplanation(idx){
  const item = QUESTIONS[idx];
  if(!item) return;
  explainBox.style.display = 'block';
  explainBox.innerHTML = `<strong>Explanation:</strong><br>${item.explanation}<br><br><strong>Correct:</strong> ${String.fromCharCode(65+item.answer)}. ${item.options[item.answer]}`;
}

/* ============== Controls ============== */
btnStart.addEventListener('click', ()=>{
  // validate again
  const name = inpName.value.trim();
  const reg = inpReg.value.trim();
  if(!validateName(name) || !validateReg(reg)){ alert('Enter valid Name and 8-digit Registration number.'); return; }
  if(!QUESTIONS || QUESTIONS.length === 0){ alert('Question bank empty. Paste QUESTIONS into the file.'); return; }

  // save user to localStorage (temp)
  const user = {name, reg, pic: null};
  if(inpPic.files && inpPic.files[0]){
    // read as data URL
    const reader = new FileReader();
    reader.onload = function(e){
      user.pic = e.target.result;
      startTest(user);
    }
    reader.readAsDataURL(inpPic.files[0]);
  } else {
    startTest(user);
  }
});
function startTest(user){
  // store last user
  localStorage.setItem('ECE-249_user', JSON.stringify(user));
  // show test page
  startPage.style.display = 'none';
  testPage.style.display = 'block';
  if(user.pic){ userPicSmall.src = user.pic; userPicSmall.style.display='block'; }
  showName.innerText = user.name; showReg.innerText = user.reg; showUser.innerText = `${user.name} â€¢ ${user.reg}`;
  state.started = true; startTimer(); resetIdleTimer(); renderQuestion(state.current); updateTopStatus();
}

/* Prev/Next */
btnPrev.addEventListener('click', ()=>{ if(state.current>0){ state.current--; renderQuestion(state.current); } resetIdleTimer();});
btnNext.addEventListener('click', ()=>{ if(state.current < totalQ - 1){ state.current++; renderQuestion(state.current); } resetIdleTimer();});

/* End Test */
btnEndTestTop.addEventListener('click', ()=>{ if(!state.started){ alert('Test not started.'); return;} if(!confirm('End test now and save result?')) return; stopTimer(); saveResult(); showSummaryModal(); });

/* Show explain */
btnShowExplain.addEventListener('click', ()=>{ showExplanation(state.current); });

/* Keyboard navigation */
document.addEventListener('keydown', (e)=>{ if(e.key === 'ArrowRight') btnNext.click(); if(e.key === 'ArrowLeft') btnPrev.click(); });

/* Reset start page */
btnResetStart.addEventListener('click', ()=>{ if(confirm('Reset start form?')){ inpName.value=''; inpReg.value=''; inpPic.value=''; imgPreview.style.display='none'; checkStartInputs(); } });

/* Save result to localStorage */
function saveResult(){
  const correct = state.answeredCorrect.filter(x=>x).length;
  const attempted = state.answers.filter(a=>a!==null).length;
  const user = JSON.parse(localStorage.getItem('ECE-249_user') || '{}');
  const result = { name: user.name || inpName.value, reg: user.reg || inpReg.value, pic: user.pic || null, correct, attempted, time: formatTime(state.elapsedSec), date: (new Date()).toLocaleString() };
  
  // ðŸ”— also save online
  saveResultToSupabase(result); 

  // const key = 'ECE-249_results';
  // const arr = JSON.parse(localStorage.getItem(key) || '[]');
  // arr.push(result);
  // localStorage.setItem(key, JSON.stringify(arr));
  // alert('Result saved locally.');
}

// ðŸŒ€ Small loader toast (for showing saving progress)

function showLoader(msg, duration = 1500) {
  const toast = document.createElement('div');
  toast.style.position = 'fixed';
  toast.style.left = '50%';
  toast.style.transform = 'translateX(-50%)';
  toast.style.bottom = '30px';
  toast.style.background = 'rgba(0,0,0,0.8)';
  toast.style.color = '#fff';
  toast.style.padding = '12px 18px';
  toast.style.borderRadius = '10px';
  toast.style.fontSize = '14px';
  toast.style.zIndex = 9999;
  toast.innerText = msg;
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.style.transition = 'opacity .4s';
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 400);
  }, duration);
}


// // ðŸŸ¢ Supabase Database Save (adds result to test_result table)
// async function saveResultToSupabase(result) {
//   try {
//     // à¤ªà¤¹à¤²à¥‡ check à¤•à¤°à¥‹ à¤•à¤¿ à¤¯à¤¹ registration à¤ªà¤¹à¤²à¥‡ à¤¸à¥‡ à¤®à¥Œà¤œà¥‚à¤¦ à¤¤à¥‹ à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆ
//     const { data: existing, error: fetchError } = await supabase
//       .from('test_result')
//       .select('reg')
//       .eq('reg', result.reg);

//     if (fetchError) throw fetchError;

//     if (existing && existing.length > 0) {
//       alert('âš ï¸ This registration number has already submitted a result!');
//       return;
//     }

//     // Insert new result
//     const { data, error } = await supabase
//       .from('test_result')
//       .insert([result]);

//     if (error) throw error;

//     alert('âœ… Result saved to Supabase database!');
//   } catch (err) {
//     console.error('Supabase insert error:', err);
//     alert('âŒ Error saving result to Supabase.');
//   }
// }
/* Export CSV for all saved results */

// ðŸŸ¢ Supabase Database Save (adds result to test_result table)
async function saveResultToSupabase(result) {
  try {
    showLoader("â³ Checking registration...");

    // à¤ªà¤¹à¤²à¥‡ check à¤•à¤°à¥‹ à¤•à¤¿ à¤¯à¤¹ registration à¤ªà¤¹à¤²à¥‡ à¤¸à¥‡ à¤®à¥Œà¤œà¥‚à¤¦ à¤¤à¥‹ à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆ
    const { data: existing, error: fetchError } = await supabase
      .from('test_result')
      .select('reg')
      .eq('reg', result.reg);

    if (fetchError) throw fetchError;

    if (existing && existing.length > 0) {
      showLoader("âš ï¸ Already submitted!", 2000);
      alert('âš ï¸ This registration number has already submitted a result!');
      return;
    }

    showLoader("ðŸ’¾ Saving your result...");

    // Insert new result
    const { data, error } = await supabase
      .from('test_result')
      .insert([result]);

    if (error) throw error;

    showLoader("âœ… ðŸ˜ƒSaved successfully!", 1800);
    alert('âœ…  ðŸ˜ƒResult saved to Aryan_data_base!');

  } catch (err) {
    console.error('Aryan_data_base insert error:', err);
    showLoader("âŒðŸ¥²ðŸ¥² Error saving result!", 2000);
    alert('âŒðŸ¥²ðŸ¥² Error saving result to Aryan_data_base.');
  }
}

// ðŸŸ¢ Fetch all saved results from Supabase (Leaderboard)
async function fetchAllResults() {
  try {
    showLoader("ðŸ“¡ Fetching results...");

    const { data, error } = await supabase
      .from('test_result')
      .select('name, reg, correct, attempted, time, date')
      .order('correct', { ascending: false }); // Highest score first

    if (error) throw error;

    showResultsTable(data); // show inside modal
  } catch (err) {
    console.error("Aryan_database fetch error:", err);
    alert("âŒ Error fetching results from Aryan_database!");
  }
}

btnExport.addEventListener('click', ()=>{
  const arr = JSON.parse(localStorage.getItem('ece249_results') || '[]');
  if(arr.length === 0){ alert('No saved results to export.'); return; }
  const headers = ['Name','Reg','Correct','Attempted','Time','Date'];
  const rows = arr.map(r => [r.name, r.reg, r.correct, r.attempted, r.time, r.date]);
  let csv = headers.join(',') + '\n' + rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'ece249_results.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* View summary modal */
function showSummaryModal(){
  const correct = state.answeredCorrect.filter(x=>x).length;
  const attempted = state.answers.filter(a=>a!==null).length;
  modalRoot.innerHTML = '';
  const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop';
  const modal = document.createElement('div'); modal.className = 'modal';
  const user = JSON.parse(localStorage.getItem('ece249_user') || '{}');
  modal.innerHTML = `<h3>Test Summary</h3>
    <p><strong>Name:</strong> ${user.name || inpName.value} &nbsp; â€¢ &nbsp; <strong>Reg:</strong> ${user.reg || inpReg.value}</p>
    <p><strong>Score:</strong> ${correct} / ${totalQ} &nbsp; â€¢ &nbsp; <strong>Attempted:</strong> ${attempted}</p>
    <p><strong>Time:</strong> ${formatTime(state.elapsedSec)}</p>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="modalSave" class="btn">Save</button>
      <button id="modalReview" class="btn ghost">Review Answers</button>
      <button id="modalClose" class="btn ghost">Close</button>
    </div>`;
  backdrop.appendChild(modal); modalRoot.appendChild(backdrop); modalRoot.style.display = 'block';
  document.getElementById('modalClose').addEventListener('click', ()=>{ modalRoot.innerHTML=''; modalRoot.style.display='none'; });
  document.getElementById('modalSave').addEventListener('click', ()=>{ saveResult(); modalRoot.innerHTML=''; modalRoot.style.display='none'; });
  document.getElementById('modalReview').addEventListener('click', ()=>{ modalRoot.innerHTML=''; modalRoot.style.display='none'; reviewAllAnswers(); });
}

/* Review answers (list with question and selected) */
function reviewAllAnswers(){
  modalRoot.innerHTML = ''; const backdrop = document.createElement('div'); backdrop.className='modal-backdrop';
  const modal = document.createElement('div'); modal.className='modal';
  modal.innerHTML = `<h3>Review Answers</h3><div style="max-height:60vh;overflow:auto"><table class="results-table"><thead><tr><th>#</th><th>Question</th><th>Your</th><th>Correct</th></tr></thead><tbody id="revBody"></tbody></table></div><div style="display:flex;justify-content:flex-end;margin-top:8px"><button id="closeRev" class="btn ghost">Close</button></div>`;
  backdrop.appendChild(modal); modalRoot.appendChild(backdrop); modalRoot.style.display='block';
  const body = modal.querySelector('#revBody');
  QUESTIONS.forEach((q,i)=>{
    const your = state.answers[i] === null ? '-' : String.fromCharCode(65 + state.answers[i]) + '. ' + q.options[state.answers[i]];
    const corr = String.fromCharCode(65 + q.answer) + '. ' + q.options[q.answer];
    const tr = document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td style="max-width:380px">${q.q}</td><td>${your}</td><td>${corr}</td>`;
    body.appendChild(tr);
  });
  document.getElementById('closeRev').addEventListener('click', ()=>{ modalRoot.innerHTML=''; modalRoot.style.display='none'; });
}

/* review finished. */

/* idle reset on any interaction */
['click','mousemove','keydown','touchstart'].forEach(ev => document.addEventListener(ev, resetIdleTimer));

/* Before unload confirm if started */
window.addEventListener('beforeunload', function(e){ if(state.started){ e.preventDefault(); e.returnValue = ''; } });

/* init */
(function init(){
  // if previous user exists, prefill name/reg
  const prevUser = JSON.parse(localStorage.getItem('ECE-249_user') || 'null');
  if(prevUser){
    if(prevUser.name) inpName.value = prevUser.name;
    if(prevUser.reg) inpReg.value = prevUser.reg;
    if(prevUser.pic){ imgPreview.src = prevUser.pic; imgPreview.style.display='block'; userPicSmall.src = prevUser.pic; userPicSmall.style.display='block'; }
  }
  checkStartInputs();
  curQ.innerText = 0;
  timeTop.innerText = '00:00';
  timeSpentEl.innerText = '00:00';
  topProgress.innerText = '0%';
  topCorrect.innerText = '0';
  topWrong.innerText = '0';
  topAttempted.innerText = '0';
  topQno.innerText = '0/' + totalQ;
})();
</script>
</body>
</html>
